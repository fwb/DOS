local baseURL = "https://raw.github.com/fwb/DOS/master/"

local component = require( "component" )
local internet = require( "internet" )
local fs = require( "filesystem" )
local shell = require( "shell" )

function wget( file )

	local filename = fs.name( file )

	--print( "File: " .. file .. ", " .. string.len( file ) .. " | Filename: " .. filename .. ", " .. string.len( filename ) )

	local path = shell.getWorkingDirectory( )

	if string.len( file ) > string.len( filename ) then
		path = path .. fs.path( file )
		--print( "Path " .. path .. ", file " .. filename )
		if not fs.exists( path ) then
			fs.makeDirectory( path )
		end
	end

	filename = fs.concat( path, filename )
	local url = baseURL .. file

	print( "Retrieving " .. url .. " to " .. filename .. "" )

	local status, data = pcall( internet.request, url )
	if data then
		if fs.exists( filename ) then
			--print( "Replacing existing file " .. filename )
			fs.remove( filename )
		end
		
		--print( "Opening [" .. filename .. "] for writing" )

		local stream = assert( io.open( filename, "w" ) )
		for chunk in data do
			stream:write( chunk )
		end
		stream:close( )
	end

end

if not internet or not component.isAvailable( "internet" ) then
	print( "ERROR: Internet access not available" )
	return
end

wget( "manifest" )

local fh = io.open( "manifest", "r" )

while true do
	local line = fh:read( )
	if line == nil then
		break
	end

	line = line:gsub("^%s*(.-)%s*$", "%1")
	--print( "Read [" .. line .. "] from manifest.")

	wget( line )
end

if not fs.exists( fs.concat( shell.getWorkingDirectory( ), "dos.conf" ) ) then
	fs.copy( "dos.conf-SAMPLE", "dos.conf" )
end